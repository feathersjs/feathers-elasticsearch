name: Test Matrix

on:
  push:
    branches: [ main, master, dove ]
  pull_request:
    branches: [ main, master, dove ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]
        elasticsearch-version: ['8.15.0', '9.0.0']

    name: Node ${{ matrix.node-version }} - ES ${{ matrix.elasticsearch-version }}

    steps:
    - uses: actions/checkout@v3

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}

    - name: Start Elasticsearch ${{ matrix.elasticsearch-version }}
      run: |
        docker run -d \
          --name elasticsearch \
          -p 9200:9200 \
          -e "discovery.type=single-node" \
          -e "xpack.security.enabled=false" \
          -e "xpack.security.enrollment.enabled=false" \
          docker.elastic.co/elasticsearch/elasticsearch:${{ matrix.elasticsearch-version }}

    - name: Wait for Elasticsearch
      run: |
        for i in {1..30}; do
          if curl -s "http://localhost:9200/_cluster/health" > /dev/null 2>&1; then
            echo "Elasticsearch is ready"
            break
          fi
          echo "Waiting for Elasticsearch..."
          sleep 5
        done

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: npm run build

    - name: Run tests
      run: |
        ES_VERSION=${{ matrix.elasticsearch-version }} \
        ELASTICSEARCH_URL=http://localhost:9200 \
        npm run mocha

    - name: Upload coverage
      if: matrix.node-version == '20' && matrix.elasticsearch-version == '8.15.0'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
